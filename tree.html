<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3Dåœ£è¯æ ‘ï¼ˆæ‰‹æœºé€‚é…ç‰ˆï¼‰</title>
    <style>
        :root {
            --bg-color: #050a05;
            --gold: #D4AF37;
            --red: #8B0000;
        }
        body { margin: 0; overflow: hidden; background: var(--bg-color); font-family: sans-serif; }
        
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        #instructions {
            position: absolute;
            top: 20px; left: 20px;
            color: var(--gold);
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 8px;
            max-width: 250px;
            font-size: 14px;
        }
        .key-point { font-weight: bold; color: #fff; }
        #control-btn {
            position: absolute;
            bottom: 20px; left: 50%;
            transform: translateX(-50%);
            pointer-events: auto;
            background: var(--red);
            color: white;
            padding: 12px 24px;
            border: 1px solid var(--gold);
            border-radius: 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 10px var(--red);
        }
        #upload-btn {
            position: absolute;
            top: 20px; right: 20px;
            pointer-events: auto;
            background: var(--red);
            color: white;
            padding: 12px 24px;
            border: 1px solid var(--gold);
            border-radius: 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 10px var(--red);
        }
        input[type="file"] { display: none; }
    </style>
    <!-- æœ¬åœ°Three.jsï¼ˆæ‰“åŒ…ç‰ˆï¼Œæ— CDNä¾èµ–ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
</head>
<body>
    <div id="ui-layer">
        <div id="instructions">
            <h3>ğŸ„ 3Dåœ£è¯æ ‘</h3>
            <p><span class="key-point">ğŸ‘‡ ç‚¹å‡»æŒ‰é’®:</span> åˆ‡æ¢èšåˆ/æ•£å¼€æ¨¡å¼</p>
            <p><span class="key-point">ğŸ“· ä¸Šä¼ ç…§ç‰‡:</span> æ·»åŠ è‡ªå®šä¹‰ç´ æ</p>
        </div>
        <button id="control-btn">èšåˆæˆåœ£è¯æ ‘</button>
        <label id="upload-btn">
            ä¸Šä¼ ç…§ç‰‡
            <input type="file" id="file-input" accept="image/*">
        </label>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        const state = {
            mode: 'TREE', // TREE=èšåˆ SCATTER=æ•£å¼€
            zoomIndex: -1
        };

        // é…ç½®é¡¹
        const CONFIG = {
            colors: { green: 0x2F4F4F, gold: 0xFFD700, red: 0x8B0000 },
            particleCount: 200,
            treeHeight: 20,
            treeRadius: 8,
            scatterRadius: 30
        };

        // 1. åˆå§‹åŒ–Three.jsåœºæ™¯
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050a05, 0.02);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 10, 40);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        document.body.appendChild(renderer.domElement);

        // ç¯å…‰
        scene.add(new THREE.AmbientLight(0xffffff, 0.2));
        const spotLight = new THREE.SpotLight(CONFIG.colors.gold, 500);
        spotLight.position.set(20, 50, 20);
        scene.add(spotLight);
        const redLight = new THREE.PointLight(CONFIG.colors.red, 200, 50);
        redLight.position.set(-10, 10, 10);
        scene.add(redLight);

        // è¾‰å…‰æ•ˆæœ
        const renderScene = new THREE.RenderPass(scene, camera);
        const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.2;
        bloomPass.strength = 1.0;
        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // 2. åˆ›å»º3Då¯¹è±¡
        const objects = [];
        const textureLoader = new THREE.TextureLoader();

        // æè´¨
        const matGold = new THREE.MeshStandardMaterial({ color: CONFIG.colors.gold, metalness: 0.9 });
        const matGreen = new THREE.MeshStandardMaterial({ color: CONFIG.colors.green, metalness: 0.2 });
        const matRed = new THREE.MeshStandardMaterial({ color: CONFIG.colors.red, metalness: 0.6, emissive: 0x330000 });

        // å‡ ä½•å½¢çŠ¶
        const geoSphere = new THREE.SphereGeometry(0.5, 16, 16);
        const geoBox = new THREE.BoxGeometry(0.8, 0.8, 0.8);

        // ç”Ÿæˆåœ£è¯æ ‘ä½ç½®
        function getTreePosition(index, total, isOuter=false) {
            const y = (index / total) * CONFIG.treeHeight;
            const r = (1 - index/total) * CONFIG.treeRadius + (isOuter ? 2 : 0);
            const angle = index * 137.5 * Math.PI/180;
            return new THREE.Vector3(r*Math.cos(angle), y-CONFIG.treeHeight/2, r*Math.sin(angle));
        }

        // ç”Ÿæˆæ•£å¼€ä½ç½®
        function getScatterPosition() {
            const v = new THREE.Vector3();
            v.randomDirection().multiplyScalar(Math.random()*CONFIG.scatterRadius + 10);
            return v;
        }

        // åˆ›å»ºè£…é¥°ç²’å­
        function createDecorations() {
            for (let i=0; i<CONFIG.particleCount; i++) {
                const mesh = Math.random()<0.6 
                    ? new THREE.Mesh(geoSphere, Math.random()<0.3 ? matGold : (Math.random()<0.6 ? matRed : matGreen))
                    : new THREE.Mesh(geoBox, Math.random()<0.5 ? matGold : matRed);
                
                mesh.position.set((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*100);
                mesh.userData = {
                    type: 'decoration',
                    posTree: getTreePosition(i, CONFIG.particleCount),
                    posScatter: getScatterPosition(),
                    rotationSpeed: new THREE.Vector3(Math.random()*0.02, Math.random()*0.02, 0)
                };
                scene.add(mesh);
                objects.push(mesh);
            }
        }

        // åˆ›å»ºç…§ç‰‡å ä½ç¬¦
        function createPhotoPlaceholder(imgUrl=null) {
            const geometry = new THREE.PlaneGeometry(3, 4);
            let material;

            if (imgUrl) {
                const tex = textureLoader.load(imgUrl);
                tex.colorSpace = THREE.SRGBColorSpace;
                material = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
            } else {
                // é»˜è®¤å ä½å›¾
                const canvas = document.createElement('canvas');
                canvas.width = 256; canvas.height = 340;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,256,340);
                ctx.fillStyle = '#ccc'; ctx.fillRect(10,10,236,250);
                ctx.fillStyle = '#000'; ctx.font = '30px Arial'; ctx.fillText('PHOTO', 80, 150);
                const tex = new THREE.CanvasTexture(canvas);
                material = new THREE.MeshBasicMaterial({ map: tex, side: THREE.DoubleSide });
            }

            const mesh = new THREE.Mesh(geometry, material);
            const i = objects.length;
            mesh.userData = {
                type: 'photo',
                posTree: getTreePosition(i, CONFIG.particleCount+10, true),
                posScatter: getScatterPosition()
            };
            mesh.position.copy(mesh.userData.posScatter);
            scene.add(mesh);
            objects.push(mesh);
        }

        // åˆå§‹åŒ–ç²’å­å’Œé»˜è®¤ç…§ç‰‡
        createDecorations();
        for(let k=0; k<3; k++) createPhotoPlaceholder();

        // 3. äº¤äº’æ§åˆ¶ï¼ˆç‚¹å‡»æŒ‰é’®åˆ‡æ¢æ¨¡å¼ï¼‰
        const controlBtn = document.getElementById('control-btn');
        controlBtn.addEventListener('click', () => {
            if (state.mode === 'TREE') {
                state.mode = 'SCATTER';
                controlBtn.textContent = 'èšåˆæˆåœ£è¯æ ‘';
            } else {
                state.mode = 'TREE';
                controlBtn.textContent = 'æ•£å¼€/æ—‹è½¬è§†è§’';
            }
        });

        // ç…§ç‰‡ä¸Šä¼ 
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => createPhotoPlaceholder(event.target.result);
                reader.readAsDataURL(file);
                state.mode = 'SCATTER';
                controlBtn.textContent = 'èšåˆæˆåœ£è¯æ ‘';
            }
        });

        // 4. åŠ¨ç”»å¾ªç¯
        const clock = new THREE.Clock();
        const lerpSpeed = 0.05;
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            // åœºæ™¯æ—‹è½¬
            if (state.mode === 'SCATTER') {
                scene.rotation.y += 0.01; // æ•£å¼€æ—¶å¿«é€Ÿæ—‹è½¬
                scene.rotation.x += Math.sin(clock.getElapsedTime()*0.5) * 0.005;
            } else {
                scene.rotation.y += 0.005; // èšåˆæ—¶æ…¢é€Ÿæ—‹è½¬
                scene.rotation.x *= 0.95;
            }

            // æ›´æ–°å¯¹è±¡ä½ç½®
            objects.forEach((obj, idx) => {
                const target = new THREE.Vector3();
                if (state.mode === 'TREE') {
                    target.copy(obj.userData.posTree);
                    target.y += Math.sin(clock.getElapsedTime()*2 + idx) * 0.1;
                } else {
                    target.copy(obj.userData.posScatter);
                    target.x += Math.cos(clock.getElapsedTime()+idx) * 0.05;
                    target.y += Math.sin(clock.getElapsedTime()+idx) * 0.05;
                }

                obj.position.lerp(target, lerpSpeed);
                if (obj.userData.type === 'decoration') {
                    obj.rotation.x += obj.userData.rotationSpeed.x;
                    obj.rotation.y += obj.userData.rotationSpeed.y;
                }
            });

            composer.render();
        }

        // çª—å£é€‚é…
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        // å¯åŠ¨åŠ¨ç”»
        animate();
    </script>
</body>
</html>
